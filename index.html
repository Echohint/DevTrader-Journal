<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProTrader Lite</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDi8RF59y1nwso78Zi3Wu8uxjc00yPRSQY",
            authDomain: "dev-trader-ac3ce.firebaseapp.com",
            databaseURL: "https://dev-trader-ac3ce-default-rtdb.firebaseio.com",
            projectId: "dev-trader-ac3ce",
            storageBucket: "dev-trader-ac3ce.firebasestorage.app",
            messagingSenderId: "61667328586",
            appId: "1:61667328586:web:4a3ae80c7012335c461cb3",
            measurementId: "G-LZHWCYY6ZG"
        };
        const GEMINI_API_KEY = "AIzaSyCL1goQPGdTFp_IizpTteU9ZTvcTQG3kzM";

        // Init Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- CONSTANTS ---
        const DEFAULT_RULES = [
            { text: "Followed Plan", checked: false },
            { text: "Risk Managed", checked: false },
            { text: "No Tilt", checked: false },
        ];

        // --- ICONS ---
        const Icons = {
            Lock: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>,
            Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg>,
            ChevronDown: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"/></svg>,
            ChevronUp: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 15l7-7 7 7"/></svg>,
            Robot: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
        };

        // --- UTILS ---
        const formatCurrency = (val) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(val);

        // --- COMPONENTS ---

        // 1. Auth Screen
        const Auth = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [isReg, setIsReg] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                const action = isReg ? auth.createUserWithEmailAndPassword(email, pass) : auth.signInWithEmailAndPassword(email, pass);
                action.then(onLogin).catch(e => alert(e.message));
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-sm bg-slate-800 p-8 rounded-2xl shadow-xl border border-slate-700">
                        <h2 className="text-2xl font-bold text-white mb-6 text-center">{isReg ? 'Create Account' : 'Trader Login'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-white" type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input className="w-full bg-slate-900 border border-slate-700 p-3 rounded text-white" type="password" placeholder="Password" value={pass} onChange={e=>setPass(e.target.value)} />
                            <button className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold p-3 rounded">{isReg ? 'Register' : 'Login'}</button>
                        </form>
                        <button onClick={()=>setIsReg(!isReg)} className="w-full mt-4 text-sm text-slate-400 hover:text-white">
                            {isReg ? 'Have an account? Login' : 'Need an account? Register'}
                        </button>
                    </div>
                </div>
            );
        };

        // 2. Simple AI Modal
        const AIModal = ({ isOpen, close, data }) => {
            const [response, setResponse] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if(isOpen && !response) {
                    setLoading(true);
                    const prompt = `Analyze these last 5 trades: ${JSON.stringify(data.slice(-5))}. Give 1 short advice.`;
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    })
                    .then(res => res.json())
                    .then(json => setResponse(json.candidates?.[0]?.content?.parts?.[0]?.text || "No insights."))
                    .catch(() => setResponse("AI Error."))
                    .finally(() => setLoading(false));
                }
            }, [isOpen]);

            if(!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" onClick={close}>
                    <div className="bg-slate-800 p-6 rounded-xl max-w-lg w-full border border-slate-700" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><Icons.Robot /> AI Insight</h3>
                        <div className="text-slate-300 min-h-[100px]">
                            {loading ? "Analyzing your journal..." : response}
                        </div>
                        <button onClick={close} className="mt-4 w-full bg-slate-700 hover:bg-slate-600 py-2 rounded text-white">Close</button>
                    </div>
                </div>
            );
        };

        // 3. Main App
        const App = ({ user }) => {
            const [data, setData] = useState(null);
            const [tab, setTab] = useState('dashboard'); // 'dashboard' | 'journal'
            const [expandedDay, setExpandedDay] = useState(null);
            const [aiOpen, setAiOpen] = useState(false);

            // Data Init
            useEffect(() => {
                db.ref(`users/${user.uid}/journal`).once('value', snap => {
                    if(snap.exists()) setData(snap.val());
                    else {
                        // Create default structure
                        const months = [];
                        let d = new Date();
                        for(let i=0; i<3; i++) { // Generate 3 months
                            const days = [];
                            for(let j=0; j<20; j++) { // 20 trading days
                                days.push({
                                    id: `${i}-${j}`, day: j+1, date: d.toISOString().split('T')[0],
                                    actual: '', pnlSign: '+', logic: '', rules: [...DEFAULT_RULES],
                                    capital: 0, target: 0
                                });
                                d.setDate(d.getDate() + 1);
                            }
                            months.push({ name: d.toLocaleString('default',{month:'long'}), days });
                        }
                        const initData = { initialCapital: 50000, finalTarget: 1000000, months };
                        setData(initData);
                        db.ref(`users/${user.uid}/journal`).set(initData);
                    }
                });
            }, [user]);

            // Save Data
            const saveData = (newData) => {
                setData(newData);
                db.ref(`users/${user.uid}/journal`).set(newData);
            };

            const updateDay = (mIdx, dIdx, field, val) => {
                const newData = {...data};
                newData.months[mIdx].days[dIdx][field] = val;
                
                // Recalculate Equity
                let cap = newData.initialCapital;
                newData.months.forEach(m => {
                    m.days.forEach(day => {
                        const pnl = day.actual ? parseFloat(day.actual) * (day.pnlSign === '+' ? 1 : -1) : 0;
                        cap += pnl;
                        day.capital = cap;
                    });
                });
                saveData(newData);
            };

            if(!data) return <div className="text-center mt-20 text-blue-400">Loading Journal...</div>;

            // Derived Stats
            const allDays = data.months.flatMap(m => m.days);
            const tradedDays = allDays.filter(d => d.actual !== '');
            const currentEquity = tradedDays.length > 0 ? tradedDays[tradedDays.length-1].capital : data.initialCapital;
            const netPnl = currentEquity - data.initialCapital;
            const wins = tradedDays.filter(d => d.pnlSign === '+' && parseFloat(d.actual) > 0).length;
            const winRate = tradedDays.length ? ((wins / tradedDays.length) * 100).toFixed(0) : 0;
            const chartData = [{name:'Start', val: data.initialCapital}, ...tradedDays.map(d => ({name: `D${d.day}`, val: d.capital}))];

            return (
                <div className="max-w-4xl mx-auto p-4 pb-20">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-xl font-bold text-white tracking-tight">ProTrader<span className="text-blue-500">Lite</span></h1>
                        <button onClick={() => auth.signOut()} className="text-xs text-slate-500 hover:text-red-400">Logout</button>
                    </div>

                    {/* Navigation Tabs */}
                    <div className="flex gap-2 mb-6 p-1 bg-slate-800 rounded-lg w-fit">
                        <button onClick={()=>setTab('dashboard')} className={`px-4 py-2 rounded-md text-sm font-medium transition ${tab==='dashboard' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>Dashboard</button>
                        <button onClick={()=>setTab('journal')} className={`px-4 py-2 rounded-md text-sm font-medium transition ${tab==='journal' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>Journal</button>
                    </div>

                    {/* DASHBOARD VIEW */}
                    {tab === 'dashboard' && (
                        <div className="space-y-6 animate-fade-in">
                            {/* Stats Grid */}
                            <div className="grid grid-cols-3 gap-4">
                                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                    <div className="text-slate-500 text-xs uppercase font-bold">Equity</div>
                                    <div className="text-xl font-mono text-white mt-1 font-bold">{formatCurrency(currentEquity)}</div>
                                </div>
                                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                    <div className="text-slate-500 text-xs uppercase font-bold">Net P&L</div>
                                    <div className={`text-xl font-mono mt-1 font-bold ${netPnl>=0?'text-green-400':'text-red-400'}`}>{formatCurrency(netPnl)}</div>
                                </div>
                                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                    <div className="text-slate-500 text-xs uppercase font-bold">Win Rate</div>
                                    <div className="text-xl font-mono text-blue-400 mt-1 font-bold">{winRate}%</div>
                                </div>
                            </div>

                            {/* Chart */}
                            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700 h-64">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={chartData}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                                        <Tooltip contentStyle={{backgroundColor: '#1e293b', borderColor: '#334155'}} />
                                        <Line type="monotone" dataKey="val" stroke="#3b82f6" strokeWidth={3} dot={false} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                            
                            <button onClick={()=>setAiOpen(true)} className="w-full py-3 bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl text-white font-bold shadow-lg">
                                Ask AI Coach Analysis
                            </button>
                        </div>
                    )}

                    {/* JOURNAL VIEW (Simple List) */}
                    {tab === 'journal' && (
                        <div className="space-y-4">
                            {data.months.map((month, mIdx) => (
                                <div key={mIdx} className="space-y-2">
                                    <h3 className="text-slate-400 text-xs font-bold uppercase ml-1 mt-4">{month.name}</h3>
                                    {month.days.map((day, dIdx) => {
                                        const isExpanded = expandedDay === day.id;
                                        const hasData = day.actual !== '';
                                        const pnlVal = parseFloat(day.actual || 0);
                                        const color = hasData ? (day.pnlSign === '+' && pnlVal > 0 ? 'text-green-400' : (day.pnlSign === '-' && pnlVal > 0 ? 'text-red-400' : 'text-slate-400')) : 'text-slate-600';

                                        return (
                                            <div key={day.id} className="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden transition-all">
                                                {/* Header Row */}
                                                <div 
                                                    onClick={() => setExpandedDay(isExpanded ? null : day.id)}
                                                    className="flex items-center justify-between p-3 cursor-pointer hover:bg-slate-750"
                                                >
                                                    <div className="flex items-center gap-3">
                                                        <span className="font-mono text-xs text-slate-500 bg-slate-900 px-2 py-1 rounded">D{day.day}</span>
                                                        <span className="text-sm text-slate-300">{day.date}</span>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className={`font-mono font-bold text-sm ${color}`}>
                                                            {hasData ? (day.pnlSign + formatCurrency(day.actual)) : '---'}
                                                        </span>
                                                        {isExpanded ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                                                    </div>
                                                </div>

                                                {/* Expanded Details */}
                                                {isExpanded && (
                                                    <div className="p-4 bg-slate-900/50 border-t border-slate-700 grid gap-4">
                                                        <div className="flex items-center gap-2">
                                                            <button 
                                                                className={`px-3 py-1 rounded font-bold ${day.pnlSign === '+' ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-400'}`}
                                                                onClick={()=>updateDay(mIdx, dIdx, 'pnlSign', '+')}
                                                            >+</button>
                                                            <input 
                                                                type="number" 
                                                                className="flex-1 bg-slate-900 border border-slate-700 p-2 rounded text-white font-mono"
                                                                placeholder="Enter P&L"
                                                                value={day.actual}
                                                                onChange={(e)=>updateDay(mIdx, dIdx, 'actual', e.target.value)}
                                                            />
                                                            <button 
                                                                className={`px-3 py-1 rounded font-bold ${day.pnlSign === '-' ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-400'}`}
                                                                onClick={()=>updateDay(mIdx, dIdx, 'pnlSign', '-')}
                                                            >-</button>
                                                        </div>

                                                        <textarea 
                                                            className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-sm text-slate-300"
                                                            rows="2"
                                                            placeholder="Notes: Setup, emotions..."
                                                            value={day.logic}
                                                            onChange={(e)=>updateDay(mIdx, dIdx, 'logic', e.target.value)}
                                                        />

                                                        <div className="grid grid-cols-2 gap-2">
                                                            {day.rules.map((r, rIdx) => (
                                                                <div key={rIdx} 
                                                                    onClick={() => {
                                                                        const newRules = [...day.rules];
                                                                        newRules[rIdx].checked = !newRules[rIdx].checked;
                                                                        updateDay(mIdx, dIdx, 'rules', newRules);
                                                                    }}
                                                                    className={`cursor-pointer p-2 rounded border text-xs flex items-center gap-2 ${r.checked ? 'border-blue-500 bg-blue-900/20 text-blue-300' : 'border-slate-700 text-slate-500'}`}
                                                                >
                                                                    {r.checked ? <Icons.Check /> : <div className="w-4 h-4 border border-slate-600 rounded"></div>}
                                                                    {r.text}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            ))}
                        </div>
                    )}

                    <AIModal isOpen={aiOpen} close={()=>setAiOpen(false)} data={tradedDays} />
                </div>
            );
        };

        const Root = () => {
            const [user, setUser] = useState(null);
            useEffect(() => auth.onAuthStateChanged(setUser), []);
            return user ? <App user={user} /> : <Auth onLogin={setUser} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Root />);
    </script>
</body>
</html>
