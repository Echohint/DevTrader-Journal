<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevTrader Institutional Terminal</title>
    <meta name="theme-color" content="#0b0e11">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* Institutional Dark Theme */
        :root {
            --bg-main: #0b0e11;
            --bg-panel: #15191e;
            --bg-input: #20262d;
            --border-color: #2a3139;
            --text-primary: #e1e4e8;
            --text-secondary: #8b949e;
            --accent-buy: #0ecb81;
            --accent-sell: #f6465d;
            --accent-blue: #2962ff;
        }
        body { background-color: var(--bg-main); color: var(--text-primary); font-family: 'Inter', sans-serif; overflow: hidden; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        
        /* Utilities */
        .glass-panel { background: var(--bg-panel); border: 1px solid var(--border-color); }
        .input-field { background: var(--bg-input); border: 1px solid var(--border-color); color: white; outline: none; transition: border 0.2s; }
        .input-field:focus { border-color: var(--accent-blue); }
        
        /* Animations */
        .flash-up { animation: flashGreen 0.6s ease-out; color: var(--accent-buy) !important; }
        .flash-down { animation: flashRed 0.6s ease-out; color: var(--accent-sell) !important; }
        @keyframes flashGreen { 0% { background-color: rgba(14, 203, 129, 0.2); } 100% { background-color: transparent; } }
        @keyframes flashRed { 0% { background-color: rgba(246, 70, 93, 0.2); } 100% { background-color: transparent; } }

        /* Layout */
        .grid-layout { display: grid; grid-template-columns: 250px 1fr 300px; grid-template-rows: 50px 1fr 300px; height: 100vh; width: 100vw; }
        .nav-area { grid-column: 1 / -1; grid-row: 1; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 1rem; background: var(--bg-panel); z-index: 20; }
        .market-watch { grid-column: 1; grid-row: 2; border-right: 1px solid var(--border-color); overflow-y: auto; }
        .chart-area { grid-column: 2; grid-row: 2; position: relative; }
        .order-panel { grid-column: 3; grid-row: 2; border-left: 1px solid var(--border-color); overflow-y: auto; }
        .terminal-area { grid-column: 1 / -1; grid-row: 3; border-top: 1px solid var(--border-color); background: var(--bg-panel); overflow: hidden; display: flex; flex-direction: column; }

        /* Tabs */
        .tab-btn { padding: 8px 16px; font-size: 12px; font-weight: 600; color: var(--text-secondary); cursor: pointer; border-top: 2px solid transparent; }
        .tab-btn.active { color: var(--accent-blue); border-top-color: var(--accent-blue); background: rgba(41, 98, 255, 0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <audio id="sfx-open" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="sfx-close" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- Configuration ---
        const WATCHLIST = [
            { symbol: "BTCUSD", name: "Bitcoin", type: "CRYPTO" },
            { symbol: "ETHUSD", name: "Ethereum", type: "CRYPTO" },
            { symbol: "XAUUSD", name: "Gold", type: "METAL" },
            { symbol: "EURUSD", name: "Euro/USD", type: "FOREX" },
            { symbol: "GBPUSD", name: "GBP/USD", type: "FOREX" },
            { symbol: "USDJPY", name: "USD/JPY", type: "FOREX" },
            { symbol: "SPX500", name: "S&P 500", type: "INDEX" },
            { symbol: "NDX100", name: "Nasdaq 100", type: "INDEX" },
            { symbol: "AAPL", name: "Apple", type: "STOCK" },
            { symbol: "TSLA", name: "Tesla", type: "STOCK" },
            { symbol: "NVDA", name: "Nvidia", type: "STOCK" }
        ];

        // --- Utilities ---
        const fmtMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
        const generateId = () => Math.random().toString(36).substr(2, 9);
        
        // --- PRICE ENGINE (WebSocket + Simulation) ---
        const useMarketData = (symbol) => {
            const [price, setPrice] = useState(0);
            const [prevPrice, setPrevPrice] = useState(0);
            const [connectionStatus, setStatus] = useState('CONNECTING'); // CONNECTING, LIVE, SIM
            const wsRef = useRef(null);
            const simRef = useRef(null);

            // Reset when symbol changes
            useEffect(() => {
                setPrice(0);
                setStatus('CONNECTING');
                if(wsRef.current) wsRef.current.close();
                if(simRef.current) clearInterval(simRef.current);

                const isCrypto = /BTC|ETH|SOL|BNB|XRP|ADA|DOGE/.test(symbol.toUpperCase());

                if (isCrypto) {
                    // Use Binance WS
                    const pair = symbol.toLowerCase().replace('usd', 'usdt');
                    const ws = new WebSocket(`wss://stream.binance.com:9443/ws/${pair}@trade`);
                    
                    ws.onopen = () => setStatus('LIVE');
                    ws.onmessage = (e) => {
                        const data = JSON.parse(e.data);
                        const newPrice = parseFloat(data.p);
                        setPrice(prev => { setPrevPrice(prev); return newPrice; });
                    };
                    ws.onerror = () => { setStatus('SIM'); startSim(); };
                    wsRef.current = ws;
                } else {
                    // Use Simulation for Forex/Stocks/Metals
                    setStatus('SIM');
                    startSim();
                }

                function startSim() {
                    // Seed price based on symbol hash to keep it roughly consistent
                    let seed = symbol.split('').reduce((a,b)=>a+b.charCodeAt(0),0);
                    let basePrice = 100;
                    if(symbol.includes('XAU')) basePrice = 2650;
                    else if(symbol.includes('EUR')) basePrice = 1.05;
                    else if(symbol.includes('JPY')) basePrice = 152;
                    else if(symbol.includes('SPX')) basePrice = 5850;
                    else if(symbol.includes('AAPL')) basePrice = 230;
                    else basePrice = (seed % 1000) + 50;

                    setPrice(basePrice);

                    simRef.current = setInterval(() => {
                        setPrice(prev => {
                            setPrevPrice(prev);
                            // Random walk logic
                            const volatility = basePrice * 0.0002; 
                            const movement = (Math.random() - 0.5) * volatility;
                            return parseFloat((prev + movement).toFixed(symbol.includes('JPY') || basePrice > 1000 ? 2 : 5));
                        });
                    }, 800); // Update every 800ms
                }

                return () => {
                    if(wsRef.current) wsRef.current.close();
                    if(simRef.current) clearInterval(simRef.current);
                };
            }, [symbol]);

            return { price, prevPrice, connectionStatus };
        };

        // --- MAIN COMPONENT ---
        const App = () => {
            // --- STATE ---
            const [activeSymbol, setActiveSymbol] = useState("BTCUSD");
            const [balance, setBalance] = useState(() => parseFloat(localStorage.getItem('dt_balance')) || 50000);
            const [positions, setPositions] = useState(() => JSON.parse(localStorage.getItem('dt_positions')) || []);
            const [pendingOrders, setPendingOrders] = useState(() => JSON.parse(localStorage.getItem('dt_orders')) || []);
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('dt_history')) || []);
            
            // Inputs
            const [volume, setVolume] = useState(1.00);
            const [leverage, setLeverage] = useState(100);
            const [orderType, setOrderType] = useState('MARKET'); // MARKET, LIMIT, STOP
            const [pendingPrice, setPendingPrice] = useState("");
            const [sl, setSl] = useState("");
            const [tp, setTp] = useState("");
            const [activeTab, setActiveTab] = useState('POSITIONS'); // POSITIONS, ORDERS, HISTORY, JOURNAL

            // Data Feed
            const { price, prevPrice, connectionStatus } = useMarketData(activeSymbol);
            const direction = price > prevPrice ? 'up' : 'down';

            // --- CALCULATIONS ---
            // Margin & PnL
            const { equity, marginUsed, freeMargin, marginLevel, totalPnL } = useMemo(() => {
                let floatingPnL = 0;
                let totalMargin = 0;

                positions.forEach(pos => {
                    // Calculate PnL
                    let tradePnL = 0;
                    // Current price only applies if symbol matches active, otherwise we need a way to get prices for all open assets.
                    // SIMPLIFICATION: In this single-file app, we only update PnL for the ACTIVE symbol in real-time. 
                    // Others stay static until viewed. (Limitation of single stream).
                    // Better approach: Assume static price for others or apply random noise. 
                    // We will use the 'entryPrice' as current for non-active to prevent crazy jumps, or just show stored.
                    
                    const currentMark = (pos.symbol === activeSymbol) ? price : pos.markPrice || pos.entryPrice; 
                    
                    if (pos.type === 'BUY') tradePnL = (currentMark - pos.entryPrice) * pos.volume; // Simplified contract size 1 for stocks/crypto simplicity
                    else tradePnL = (pos.entryPrice - currentMark) * pos.volume;

                    // Update mark price in position object for persistence
                    pos.currentPnL = tradePnL;
                    pos.markPrice = currentMark;

                    floatingPnL += tradePnL;
                    totalMargin += (pos.entryPrice * pos.volume) / pos.leverage;
                });

                const eq = balance + floatingPnL;
                const fm = eq - totalMargin;
                const ml = totalMargin > 0 ? (eq / totalMargin) * 100 : 9999;

                return { equity: eq, marginUsed: totalMargin, freeMargin: fm, marginLevel: ml, totalPnL: floatingPnL };
            }, [balance, positions, price, activeSymbol]);

            // --- EFFECTS ---
            
            // Save Data
            useEffect(() => {
                localStorage.setItem('dt_balance', balance);
                localStorage.setItem('dt_positions', JSON.stringify(positions));
                localStorage.setItem('dt_orders', JSON.stringify(pendingOrders));
                localStorage.setItem('dt_history', JSON.stringify(history));
            }, [balance, positions, pendingOrders, history]);

            // Sound FX
            const playSound = (type) => {
                const audio = document.getElementById(type === 'open' ? 'sfx-open' : 'sfx-close');
                if(audio) { audio.currentTime = 0; audio.play().catch(e=>{}); }
            };

            // Order Trigger Logic (Limit/Stop/SL/TP)
            useEffect(() => {
                if (!price) return;

                // 1. Check Pending Orders
                const remainingOrders = [];
                let orderTriggered = false;
                
                pendingOrders.forEach(order => {
                    if (order.symbol !== activeSymbol) {
                        remainingOrders.push(order);
                        return;
                    }

                    let triggered = false;
                    const triggerPrice = parseFloat(order.triggerPrice);
                    
                    if (order.type === 'BUY LIMIT' && price <= triggerPrice) triggered = true;
                    else if (order.type === 'BUY STOP' && price >= triggerPrice) triggered = true;
                    else if (order.type === 'SELL LIMIT' && price >= triggerPrice) triggered = true;
                    else if (order.type === 'SELL STOP' && price <= triggerPrice) triggered = true;

                    if (triggered) {
                        // Convert to Position
                        const newPos = {
                            id: generateId(),
                            ticket: Math.floor(Math.random() * 10000000),
                            symbol: order.symbol,
                            type: order.side,
                            volume: order.volume,
                            entryPrice: price, // Fill at market
                            leverage: order.leverage,
                            sl: order.sl,
                            tp: order.tp,
                            openTime: new Date().toISOString(),
                            markPrice: price,
                            currentPnL: 0
                        };
                        setPositions(prev => [newPos, ...prev]);
                        playSound('open');
                        orderTriggered = true;
                    } else {
                        remainingOrders.push(order);
                    }
                });

                if (orderTriggered) setPendingOrders(remainingOrders);

                // 2. Check SL/TP
                const openPosCopy = [...positions];
                let positionClosed = false;

                const activePositions = openPosCopy.filter(p => p.symbol === activeSymbol);
                activePositions.forEach(pos => {
                    let close = false;
                    if (pos.type === 'BUY') {
                        if (pos.sl && price <= pos.sl) close = true;
                        else if (pos.tp && price >= pos.tp) close = true;
                    } else {
                        if (pos.sl && price >= pos.sl) close = true;
                        else if (pos.tp && price <= pos.tp) close = true;
                    }

                    if (close) {
                        closeTrade(pos.id);
                        positionClosed = true;
                    }
                });

            }, [price, activeSymbol]); // Runs on every tick of active symbol

            // --- ACTIONS ---
            const placeOrder = (side) => {
                if (!price) return alert("No price feed.");
                if (freeMargin < (price * volume / leverage) && (orderType === 'MARKET')) return alert("Not enough free margin!");

                const newOrder = {
                    id: generateId(),
                    symbol: activeSymbol,
                    volume: parseFloat(volume),
                    leverage: parseInt(leverage),
                    sl: parseFloat(sl) || null,
                    tp: parseFloat(tp) || null,
                    side: side
                };

                if (orderType === 'MARKET') {
                    // Instant Execution
                    const position = {
                        ...newOrder,
                        ticket: Math.floor(Math.random() * 10000000),
                        type: side, // BUY or SELL
                        entryPrice: price,
                        openTime: new Date().toISOString(),
                        markPrice: price,
                        currentPnL: 0
                    };
                    setPositions(prev => [position, ...prev]);
                    playSound('open');
                } else {
                    // Pending Order
                    if (!pendingPrice) return alert("Enter Price for Pending Order");
                    newOrder.triggerPrice = parseFloat(pendingPrice);
                    
                    // Determine Limit vs Stop based on logic
                    let typeStr = "";
                    const p = parseFloat(pendingPrice);
                    if (side === 'BUY') typeStr = p < price ? "BUY LIMIT" : "BUY STOP";
                    else typeStr = p > price ? "SELL LIMIT" : "SELL STOP";
                    
                    newOrder.type = typeStr;
                    newOrder.placedTime = new Date().toISOString();
                    
                    setPendingOrders(prev => [newOrder, ...prev]);
                    alert(`Order Placed: ${typeStr} @ ${pendingPrice}`);
                }
            };

            const closeTrade = (id) => {
                const posIndex = positions.findIndex(p => p.id === id);
                if (posIndex === -1) return;
                const pos = positions[posIndex];
                
                // If symbol is not active, use last mark price. If active, use current `price`
                const exitPrice = (pos.symbol === activeSymbol) ? price : pos.markPrice;
                
                // Calculate final PnL
                let pnl = 0;
                if (pos.type === 'BUY') pnl = (exitPrice - pos.entryPrice) * pos.volume;
                else pnl = (pos.entryPrice - exitPrice) * pos.volume;

                const historyItem = {
                    ...pos,
                    closeTime: new Date().toISOString(),
                    exitPrice: exitPrice,
                    finalPnL: pnl
                };

                setHistory(prev => [historyItem, ...prev]);
                setBalance(prev => prev + pnl);
                setPositions(prev => prev.filter(p => p.id !== id));
                playSound('close');
            };

            // --- RENDER HELPERS ---
            const PnlColor = ({ val }) => <span className={val >= 0 ? "text-[#0ecb81]" : "text-[#f6465d]"}>{val >= 0 ? '+' : ''}{val.toFixed(2)}</span>;

            return (
                <div className="grid-layout">
                    {/* 1. TOP NAV */}
                    <nav className="nav-area justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-blue-600 rounded flex items-center justify-center font-bold text-white">DT</div>
                            <h1 className="font-bold text-lg tracking-wide">DEVTRADER <span className="text-xs text-gray-500 font-normal ml-1">PRO TERMINAL</span></h1>
                        </div>
                        <div className="flex gap-6 text-sm font-mono">
                            <div>BAL: <span className="text-white font-bold">{fmtMoney(balance)}</span></div>
                            <div>EQ: <span className="text-white font-bold">{fmtMoney(equity)}</span></div>
                            <div>MRG: <span className="text-gray-400">{fmtMoney(marginUsed)}</span></div>
                            <div>FREE: <span className="text-white font-bold">{fmtMoney(freeMargin)}</span></div>
                            <div>LVL: <span className={marginLevel < 100 ? "text-red-500 font-bold" : "text-green-500"}>{marginLevel.toFixed(0)}%</span></div>
                        </div>
                        <div>
                            <button className="bg-red-600/20 text-red-500 px-3 py-1 rounded text-xs border border-red-900 hover:bg-red-600 hover:text-white transition" onClick={() => {if(confirm("Reset Account?")) { localStorage.clear(); window.location.reload(); }}}>RESET</button>
                        </div>
                    </nav>

                    {/* 2. MARKET WATCH (Left) */}
                    <div className="market-watch glass-panel">
                        <div className="p-3 border-b border-[#2a3139] font-bold text-xs text-gray-500">MARKET WATCH</div>
                        {WATCHLIST.map(asset => (
                            <div key={asset.symbol} 
                                 onClick={() => setActiveSymbol(asset.symbol)}
                                 className={`p-3 border-b border-[#2a3139] cursor-pointer hover:bg-[#20262d] flex justify-between items-center ${activeSymbol === asset.symbol ? 'bg-[#20262d] border-l-4 border-l-[#2962ff]' : ''}`}>
                                <div>
                                    <div className="font-bold text-sm text-white">{asset.symbol}</div>
                                    <div className="text-xs text-gray-500">{asset.name}</div>
                                </div>
                                <div className="text-right">
                                    {/* We don't stream all prices for perf, just a placeholder or static unless active */}
                                    {activeSymbol === asset.symbol ? 
                                        <div className={`font-mono text-sm ${direction === 'up' ? 'text-[#0ecb81]' : 'text-[#f6465d]'}`}>{price.toFixed(2)}</div> 
                                        : <div className="text-xs text-gray-600">Click to Load</div>}
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* 3. CHART AREA (Center) */}
                    <div className="chart-area bg-[#0b0e11]">
                        <div id={`tv_${activeSymbol}`} className="w-full h-full"></div> 
                        {/* React Effect to load chart */}
                        <TradingViewWidget symbol={activeSymbol} />
                    </div>

                    {/* 4. ORDER PANEL (Right) */}
                    <div className="order-panel glass-panel flex flex-col">
                        <div className="p-4 border-b border-[#2a3139]">
                            <h2 className="text-xl font-bold text-white mb-1">{activeSymbol}</h2>
                            <div className={`text-3xl font-mono font-bold mb-2 ${direction === 'up' ? 'flash-up' : 'flash-down'}`}>{price.toFixed(2)}</div>
                            <div className="flex items-center gap-2 text-xs text-gray-500">
                                <span className={`w-2 h-2 rounded-full ${connectionStatus === 'LIVE' ? 'bg-green-500' : 'bg-orange-500'}`}></span>
                                {connectionStatus} FEED
                            </div>
                        </div>

                        <div className="p-4 flex-1 overflow-y-auto">
                            {/* Order Type Tab */}
                            <div className="flex bg-[#20262d] rounded p-1 mb-4">
                                <button onClick={() => setOrderType('MARKET')} className={`flex-1 py-1 text-xs font-bold rounded ${orderType === 'MARKET' ? 'bg-[#2a3139] text-white' : 'text-gray-500'}`}>MARKET</button>
                                <button onClick={() => setOrderType('PENDING')} className={`flex-1 py-1 text-xs font-bold rounded ${orderType === 'PENDING' ? 'bg-[#2a3139] text-white' : 'text-gray-500'}`}>PENDING</button>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block">Volume (Lots)</label>
                                    <input type="number" value={volume} onChange={e => setVolume(e.target.value)} className="input-field w-full p-2 rounded font-mono" step="0.01" />
                                </div>
                                
                                <div>
                                    <label className="text-xs text-gray-500 mb-1 block">Leverage (1:X)</label>
                                    <select value={leverage} onChange={e => setLeverage(e.target.value)} className="input-field w-full p-2 rounded font-mono text-sm">
                                        <option value="1">1:1</option>
                                        <option value="10">1:10</option>
                                        <option value="50">1:50</option>
                                        <option value="100">1:100</option>
                                        <option value="500">1:500</option>
                                    </select>
                                </div>

                                {orderType === 'PENDING' && (
                                    <div>
                                        <label className="text-xs text-gray-500 mb-1 block">Entry Price</label>
                                        <input type="number" value={pendingPrice} onChange={e => setPendingPrice(e.target.value)} className="input-field w-full p-2 rounded font-mono" placeholder="Price..." />
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-2">
                                    <div>
                                        <label className="text-xs text-gray-500 mb-1 block">Stop Loss</label>
                                        <input type="number" value={sl} onChange={e => setSl(e.target.value)} className="input-field w-full p-2 rounded font-mono" placeholder="-" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 mb-1 block">Take Profit</label>
                                        <input type="number" value={tp} onChange={e => setTp(e.target.value)} className="input-field w-full p-2 rounded font-mono" placeholder="-" />
                                    </div>
                                </div>

                                {/* Margin Info */}
                                <div className="text-xs text-gray-500 flex justify-between mt-2">
                                    <span>Req Margin:</span>
                                    <span className="text-white font-mono">{price ? fmtMoney((price * volume) / leverage) : '-'}</span>
                                </div>

                                {/* Buttons */}
                                <div className="grid grid-cols-2 gap-3 mt-2">
                                    <button onClick={() => placeOrder('SELL')} className="bg-[#f6465d] hover:bg-[#d93a4e] text-white py-3 rounded font-bold text-sm transition shadow-lg shadow-red-900/20">
                                        SELL {orderType === 'PENDING' ? 'LIMIT/STOP' : ''}
                                    </button>
                                    <button onClick={() => placeOrder('BUY')} className="bg-[#0ecb81] hover:bg-[#0aa86b] text-white py-3 rounded font-bold text-sm transition shadow-lg shadow-green-900/20">
                                        BUY {orderType === 'PENDING' ? 'LIMIT/STOP' : ''}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 5. BOTTOM TERMINAL */}
                    <div className="terminal-area">
                        <div className="flex border-b border-[#2a3139] bg-[#15191e]">
                            <div onClick={() => setActiveTab('POSITIONS')} className={`tab-btn ${activeTab === 'POSITIONS' ? 'active' : ''}`}>Positions ({positions.length})</div>
                            <div onClick={() => setActiveTab('ORDERS')} className={`tab-btn ${activeTab === 'ORDERS' ? 'active' : ''}`}>Pending ({pendingOrders.length})</div>
                            <div onClick={() => setActiveTab('HISTORY')} className={`tab-btn ${activeTab === 'HISTORY' ? 'active' : ''}`}>History</div>
                            <div onClick={() => setActiveTab('JOURNAL')} className={`tab-btn ${activeTab === 'JOURNAL' ? 'active' : ''}`}>Journal</div>
                        </div>

                        <div className="flex-1 overflow-auto p-0 relative">
                            {activeTab === 'POSITIONS' && (
                                <table className="w-full text-left text-xs text-gray-400 border-collapse">
                                    <thead className="bg-[#20262d] sticky top-0 z-10">
                                        <tr>
                                            <th className="p-2 font-normal">Ticket</th>
                                            <th className="p-2 font-normal">Time</th>
                                            <th className="p-2 font-normal">Symbol</th>
                                            <th className="p-2 font-normal">Type</th>
                                            <th className="p-2 font-normal">Vol</th>
                                            <th className="p-2 font-normal">Price</th>
                                            <th className="p-2 font-normal">S/L</th>
                                            <th className="p-2 font-normal">T/P</th>
                                            <th className="p-2 font-normal">Mark</th>
                                            <th className="p-2 font-normal">Profit</th>
                                            <th className="p-2 font-normal">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {positions.length === 0 ? <tr><td colSpan="11" className="p-8 text-center italic opacity-50">No open positions</td></tr> : 
                                        positions.map(pos => (
                                            <tr key={pos.id} className="border-b border-[#2a3139] hover:bg-[#20262d]">
                                                <td className="p-2 font-mono">{pos.ticket}</td>
                                                <td className="p-2">{new Date(pos.openTime).toLocaleTimeString()}</td>
                                                <td className="p-2 font-bold text-white">{pos.symbol}</td>
                                                <td className={`p-2 font-bold ${pos.type === 'BUY' ? 'text-[#0ecb81]' : 'text-[#f6465d]'}`}>{pos.type}</td>
                                                <td className="p-2">{pos.volume}</td>
                                                <td className="p-2 font-mono">{pos.entryPrice.toFixed(pos.symbol.includes('JPY') ? 3 : 2)}</td>
                                                <td className="p-2 font-mono">{pos.sl || '-'}</td>
                                                <td className="p-2 font-mono">{pos.tp || '-'}</td>
                                                <td className="p-2 font-mono text-white">{pos.markPrice?.toFixed(2) || '...'}</td>
                                                <td className="p-2 font-mono font-bold"><PnlColor val={pos.currentPnL || 0} /></td>
                                                <td className="p-2"><button onClick={() => closeTrade(pos.id)} className="bg-[#2a3139] hover:bg-[#363d46] px-2 py-1 rounded text-[10px] text-white border border-gray-600">X</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}

                            {activeTab === 'ORDERS' && (
                                <table className="w-full text-left text-xs text-gray-400">
                                    <thead className="bg-[#20262d]"><tr><th className="p-2">Symbol</th><th className="p-2">Type</th><th className="p-2">Vol</th><th className="p-2">Price</th><th className="p-2">SL</th><th className="p-2">TP</th><th className="p-2">Action</th></tr></thead>
                                    <tbody>
                                        {pendingOrders.map((o, i) => (
                                            <tr key={i} className="border-b border-[#2a3139]">
                                                <td className="p-2">{o.symbol}</td>
                                                <td className="p-2 text-blue-400">{o.type}</td>
                                                <td className="p-2">{o.volume}</td>
                                                <td className="p-2">{o.triggerPrice}</td>
                                                <td className="p-2">{o.sl}</td>
                                                <td className="p-2">{o.tp}</td>
                                                <td className="p-2"><button onClick={() => setPendingOrders(pendingOrders.filter((_, idx) => idx !== i))} className="text-red-500 hover:text-white">Cancel</button></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                            
                            {activeTab === 'HISTORY' && (
                                <table className="w-full text-left text-xs text-gray-400">
                                    <thead className="bg-[#20262d]"><tr><th className="p-2">Time</th><th className="p-2">Symbol</th><th className="p-2">Type</th><th className="p-2">Vol</th><th className="p-2">Entry</th><th className="p-2">Exit</th><th className="p-2">P&L</th></tr></thead>
                                    <tbody>
                                        {history.slice(0, 50).map((h, i) => (
                                            <tr key={i} className="border-b border-[#2a3139]">
                                                <td className="p-2">{new Date(h.closeTime).toLocaleString()}</td>
                                                <td className="p-2">{h.symbol}</td>
                                                <td className={`p-2 ${h.type==='BUY'?'text-green-500':'text-red-500'}`}>{h.type}</td>
                                                <td className="p-2">{h.volume}</td>
                                                <td className="p-2">{h.entryPrice}</td>
                                                <td className="p-2">{h.exitPrice}</td>
                                                <td className="p-2 font-bold"><PnlColor val={h.finalPnL} /></td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}

                            {activeTab === 'JOURNAL' && (
                                <div className="p-4 text-center text-gray-500">
                                    <p className="mb-2">Auto-Journal is active. All closed trades are logged to local storage.</p>
                                    <div className="grid grid-cols-3 gap-4 max-w-lg mx-auto">
                                        <div className="bg-[#20262d] p-4 rounded border border-gray-700">
                                            <div className="text-xs">TOTAL TRADES</div>
                                            <div className="text-xl text-white">{history.length}</div>
                                        </div>
                                        <div className="bg-[#20262d] p-4 rounded border border-gray-700">
                                            <div className="text-xs">WIN RATE</div>
                                            <div className="text-xl text-white">{history.length > 0 ? ((history.filter(h=>h.finalPnL>0).length / history.length)*100).toFixed(1) : 0}%</div>
                                        </div>
                                        <div className="bg-[#20262d] p-4 rounded border border-gray-700">
                                            <div className="text-xs">NET P&L</div>
                                            <div className={`text-xl ${balance >= 50000 ? 'text-green-500' : 'text-red-500'}`}>${(balance - 50000).toFixed(2)}</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        {/* Status Bar */}
                        <div className="h-6 bg-[#0b0e11] border-t border-[#2a3139] flex items-center px-2 text-[10px] text-gray-500 justify-between">
                            <div>Ping: 24ms | Server: US-East | API: {activeSymbol.includes('USD') && !activeSymbol.includes('USDT') ? 'Simulated' : 'Binance Stream'}</div>
                            <div>{new Date().toUTCString()}</div>
                        </div>
                    </div>
                </div>
            );
        };

        // Helper Component: Chart
        const TradingViewWidget = React.memo(({ symbol }) => {
            const containerId = useRef(`tv_${Math.random().toString(36).substr(2, 9)}`);
            useEffect(() => {
                const script = document.createElement('script');
                script.src = 'https://s3.tradingview.com/tv.js';
                script.async = true;
                script.onload = () => {
                    if (window.TradingView) {
                        new window.TradingView.widget({
                            "autosize": true,
                            "symbol": symbol,
                            "interval": "D",
                            "timezone": "Etc/UTC",
                            "theme": "dark",
                            "style": "1",
                            "locale": "en",
                            "toolbar_bg": "#f1f3f6",
                            "enable_publishing": false,
                            "hide_side_toolbar": false,
                            "allow_symbol_change": false,
                            "container_id": containerId.current,
                            "overrides": {
                                "paneProperties.background": "#0b0e11",
                                "paneProperties.vertGridProperties.color": "#1f2937",
                                "paneProperties.horzGridProperties.color": "#1f2937",
                                "scalesProperties.textColor": "#9ca3af"
                            }
                        });
                    }
                };
                document.head.appendChild(script);
                return () => document.head.removeChild(script);
            }, [symbol]);
            return <div id={containerId.current} className="w-full h-full" />;
        });

        const PnlColor = ({ val }) => <span className={val >= 0 ? "text-[#0ecb81]" : "text-[#f6465d]"}>{val >= 0 ? '+' : ''}{val.toFixed(2)}</span>;

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
