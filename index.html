<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevTrader Pro Terminal v2.3 (AI Powered)</title>
    
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='20' fill='%230f172a'/%3e%3cpath d='M30 70 L50 40 L70 70' fill='none' stroke='%233b82f6' stroke-width='8'/%3e%3c/svg%3e">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        slate: { 850: '#172033', 900: '#0f172a', 950: '#020617' } 
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                } 
            }
        }
    </script>

    <!-- React & DOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg-app: #020617; --bg-panel: #0f172a; --primary: #3b82f6; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Glassmorphism */
        .glass-panel { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Animations */
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 h-screen overflow-hidden selection:bg-blue-500/30">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dev-trader-pro';
        const GEMINI_API_KEY = "AIzaSyCKHNgm5dKwVMSkbApaw6rxYEpQaDkqwP8"; 
        
        if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); } }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. ICONS ---
        const Icons = {
            Journal: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>,
            User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>,
            AI: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>,
            News: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>,
            Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>,
            Save: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>,
            Calendar: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Maximize: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>,
            Sparkles: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>,
            Chat: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>,
            Star: ({ filled }) => <svg className={`w-4 h-4 ${filled ? 'text-yellow-400 fill-current' : 'text-slate-600'}`} viewBox="0 0 24 24" fill="none" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
        };

        const formatCurrency = (num) => '₹' + Number(num || 0).toLocaleString('en-IN');
        const getPnlColor = (val) => val > 0 ? 'text-emerald-500' : val < 0 ? 'text-rose-500' : 'text-slate-400';

        // --- 3. HELPERS ---
        const callGemini = async (prompt) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
            const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
            const json = await res.json();
            if (json.error) throw new Error(json.error.message);
            return json.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
        };

        // --- 4. COMPONENTS ---

        const NewsFeed = () => {
            const [news, setNews] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchNews = async () => {
                    try {
                        const res = await fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.investing.com/rss/news_25.rss');
                        const data = await res.json();
                        if(data.items) setNews(data.items.slice(0, 10));
                    } catch (err) { console.error(err); } finally { setLoading(false); }
                };
                fetchNews();
            }, []);

            return (
                <div className="glass-panel p-4 rounded-xl h-full flex flex-col border-l-4 border-l-blue-600">
                    <div className="flex items-center gap-2 mb-4 text-slate-300 font-bold uppercase tracking-wider text-xs border-b border-slate-700 pb-2">
                        <Icons.News /> Market Wire
                    </div>
                    <div className="flex-1 overflow-y-auto pr-1 space-y-3 custom-scrollbar">
                        {loading ? <div className="animate-pulse text-xs text-slate-500">Connecting to wire...</div> : 
                         news.map((item, idx) => (
                            <a href={item.link} target="_blank" key={idx} className="block group">
                                <div className="bg-slate-900/50 p-3 rounded hover:bg-slate-800 transition-colors border border-slate-800 hover:border-blue-500/30 group-hover:translate-x-1 transition-transform duration-200">
                                    <h4 className="text-xs font-medium text-slate-200 leading-tight group-hover:text-blue-400 transition-colors">{item.title}</h4>
                                    <span className="text-[10px] text-slate-500 mt-2 block font-mono">{new Date(item.pubDate).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            );
        };

        const ProfileSection = ({ user, profileData, onSave }) => {
            const [formData, setFormData] = useState(profileData || {
                name: '', style: 'Scalper', experience: 'Intermediate', broker: 'Zerodha', goals: '', duration: 66
            });
            const [saving, setSaving] = useState(false);

            useEffect(() => { if(profileData) setFormData(profileData); }, [profileData]);

            const handleSave = async () => {
                setSaving(true);
                await onSave(formData);
                setSaving(false);
            };

            return (
                <div className="glass-panel p-8 rounded-xl max-w-2xl mx-auto mt-10 animate-fade-in border-t-4 border-t-blue-600">
                    <div className="flex items-center gap-4 mb-8 border-b border-slate-800 pb-8">
                        <div className="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center text-3xl font-bold text-white shadow-lg shadow-blue-500/20">
                            {formData.name ? formData.name.charAt(0).toUpperCase() : 'U'}
                        </div>
                        <div>
                            <h2 className="text-2xl font-bold text-white">Trader Profile</h2>
                            <p className="text-slate-400 text-sm font-mono mt-1">{user.uid.slice(0, 8)}... • PRO TERMINAL</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="space-y-2">
                            <label className="text-xs uppercase font-bold text-blue-400 tracking-wider">Full Name</label>
                            <input type="text" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} 
                                className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-sm text-white focus:border-blue-500 outline-none focus:ring-1 focus:ring-blue-500 transition-all"/>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs uppercase font-bold text-blue-400 tracking-wider">Challenge Duration (Days)</label>
                            <input type="number" value={formData.duration || 66} onChange={e=>setFormData({...formData, duration: parseInt(e.target.value)})} 
                                className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-sm text-white focus:border-blue-500 outline-none focus:ring-1 focus:ring-blue-500 transition-all"/>
                             <p className="text-[10px] text-slate-500">Increasing this will extend your journal.</p>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs uppercase font-bold text-blue-400 tracking-wider">Brokerage</label>
                            <input type="text" value={formData.broker} onChange={e=>setFormData({...formData, broker: e.target.value})} 
                                className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-sm text-white focus:border-blue-500 outline-none focus:ring-1 focus:ring-blue-500 transition-all"/>
                        </div>
                        <div className="space-y-2">
                            <label className="text-xs uppercase font-bold text-blue-400 tracking-wider">Trading Style</label>
                            <select value={formData.style} onChange={e=>setFormData({...formData, style: e.target.value})} 
                                className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-sm text-white focus:border-blue-500 outline-none focus:ring-1 focus:ring-blue-500 transition-all">
                                <option>Scalper</option><option>Day Trader</option><option>Swing Trader</option><option>Position Trader</option>
                            </select>
                        </div>
                        <div className="md:col-span-2 space-y-2">
                            <label className="text-xs uppercase font-bold text-blue-400 tracking-wider">Long Term Goals</label>
                            <textarea rows="3" value={formData.goals} onChange={e=>setFormData({...formData, goals: e.target.value})} 
                                className="w-full bg-slate-950 border border-slate-800 rounded p-3 text-sm text-white focus:border-blue-500 outline-none resize-none focus:ring-1 focus:ring-blue-500 transition-all"></textarea>
                        </div>
                    </div>

                    <div className="mt-8 flex justify-end">
                        <button onClick={handleSave} disabled={saving} className="flex items-center gap-2 px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-600/20">
                            {saving ? 'Syncing...' : <><Icons.Save /> Save Configuration</>}
                        </button>
                    </div>
                </div>
            );
        };

        const MonthlyReport = ({ months }) => {
            return (
                <div className="glass-panel p-6 rounded-xl mb-6">
                     <div className="text-slate-300 font-bold uppercase tracking-wider text-xs border-b border-slate-700 pb-4 mb-4 flex items-center gap-2">
                        <Icons.Calendar /> Performance Map
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        {months.map(m => {
                            const totalPnL = m.days.reduce((acc, d) => {
                                const val = Number(d.actual || 0);
                                return acc + (d.pnlSign === '+' ? val : d.pnlSign === '-' ? -val : 0);
                            }, 0);
                            return (
                                <div key={m.id} className="bg-slate-900/50 border border-slate-800 p-4 rounded hover:border-slate-600 transition-colors flex flex-col items-center">
                                    <span className="text-[10px] text-slate-500 font-bold uppercase mb-1">{m.monthName}</span>
                                    <span className={`text-lg font-mono font-bold ${getPnlColor(totalPnL)}`}>{totalPnL > 0 ? '+' : ''}{formatCurrency(totalPnL)}</span>
                                </div>
                            )
                        })}
                    </div>
                </div>
            )
        };

        const DetailedEntryModal = ({ dayData, onClose, onUpdate }) => {
            const [localData, setLocalData] = useState({...dayData.data});
            const [refining, setRefining] = useState(false);
            
            const TRADING_RULES = [
                "Followed Trading Plan",
                "Risk Management (<2%)",
                "No Revenge Trading",
                "No FOMO Entries",
                "Waited for Candle Close"
            ];

            const handleChange = (field, val) => {
                setLocalData(prev => ({...prev, [field]: val}));
            };

            const toggleRule = (rule) => {
                const currentRules = localData.rules || [];
                if (currentRules.includes(rule)) {
                    handleChange('rules', currentRules.filter(r => r !== rule));
                } else {
                    handleChange('rules', [...currentRules, rule]);
                }
            };

            const handleRefine = async () => {
                if(!localData.logic || localData.logic.length < 5) return;
                setRefining(true);
                try {
                    const prompt = `You are a professional trading mentor. Rewrite the following trader's raw journal notes into a structured, objective analysis. Keep it concise. Focus on: Setup, Execution, Psychology, Mistake/Lesson. Raw notes: "${localData.logic}"`;
                    const result = await callGemini(prompt);
                    handleChange('logic', result);
                } catch(e) { console.error(e); }
                setRefining(false);
            };

            const handleSave = () => {
                onUpdate(dayData.mIdx, dayData.dIdx, localData);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-slate-950/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-slate-900 border border-slate-700 w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh] animate-fade-in ring-1 ring-blue-500/20">
                        {/* Header */}
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50 rounded-t-2xl">
                            <div>
                                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                    Day {localData.day} <span className="text-slate-500 font-normal text-sm">| {localData.date}</span>
                                </h2>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleSave} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold text-xs">SAVE ENTRY</button>
                                <button onClick={onClose} className="p-2 text-slate-400 hover:text-white bg-slate-800 hover:bg-slate-700 rounded-lg">✕</button>
                            </div>
                        </div>

                        {/* Content */}
                        <div className="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-3 gap-6">
                            
                            {/* Left Col: Stats */}
                            <div className="space-y-4">
                                <div className="p-4 bg-slate-950 rounded-xl border border-slate-800">
                                    <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Net P&L</label>
                                    <div className="flex items-center gap-2">
                                        <button onClick={()=>handleChange('pnlSign', '+')} className={`w-10 h-10 rounded flex items-center justify-center font-bold ${localData.pnlSign==='+'?'bg-emerald-600 text-white':'bg-slate-800 text-slate-500'}`}>+</button>
                                        <input type="number" value={localData.actual} onChange={e=>handleChange('actual', e.target.value)} className="bg-transparent w-full text-center text-2xl font-mono font-bold outline-none text-white border-b border-slate-700 pb-1"/>
                                        <button onClick={()=>handleChange('pnlSign', '-')} className={`w-10 h-10 rounded flex items-center justify-center font-bold ${localData.pnlSign==='-'?'bg-rose-600 text-white':'bg-slate-800 text-slate-500'}`}>-</button>
                                    </div>
                                </div>

                                <div className="p-4 bg-slate-950 rounded-xl border border-slate-800">
                                    <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Session Rating</label>
                                    <div className="flex justify-center gap-2">
                                        {[1,2,3,4,5].map(star => (
                                            <button key={star} onClick={()=>handleChange('rating', star)} className="hover:scale-110 transition-transform">
                                                <Icons.Star filled={star <= (localData.rating || 0)} />
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Rules Checklist */}
                                <div className="p-4 bg-slate-950 rounded-xl border border-slate-800">
                                    <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Rule Compliance</label>
                                    <div className="space-y-2">
                                        {TRADING_RULES.map(rule => (
                                            <div key={rule} onClick={() => toggleRule(rule)} className="flex items-center gap-3 cursor-pointer group select-none">
                                                <div className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${
                                                    (localData.rules || []).includes(rule) 
                                                        ? 'bg-blue-600 border-blue-600 text-white shadow-sm shadow-blue-500/50' 
                                                        : 'border-slate-700 group-hover:border-slate-500 bg-slate-900'
                                                }`}>
                                                    {(localData.rules || []).includes(rule) && (
                                                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7" /></svg>
                                                    )}
                                                </div>
                                                <span className={`text-xs font-medium transition-colors ${
                                                    (localData.rules || []).includes(rule) ? 'text-blue-400' : 'text-slate-400 group-hover:text-slate-300'
                                                }`}>{rule}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div className="p-4 bg-slate-950 rounded-xl border border-slate-800">
                                    <label className="text-xs font-bold text-slate-500 uppercase block mb-2">Screenshot URL</label>
                                    <input type="text" placeholder="https://..." value={localData.screenshot || ''} onChange={e=>handleChange('screenshot', e.target.value)} 
                                        className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-blue-400 outline-none"/>
                                    {localData.screenshot && (
                                        <div className="mt-2 h-32 bg-slate-900 rounded overflow-hidden border border-slate-700 relative group">
                                            <img src={localData.screenshot} className="w-full h-full object-cover opacity-50 group-hover:opacity-100 transition-opacity" alt="Chart" />
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Right Col: Details */}
                            <div className="md:col-span-2 space-y-4">
                                <div className="space-y-2 h-full flex flex-col relative">
                                    <div className="flex justify-between items-center">
                                        <label className="text-xs font-bold text-slate-500 uppercase">Detailed Trade Logic & Psychology</label>
                                        <button onClick={handleRefine} disabled={refining} className="text-xs flex items-center gap-1 text-indigo-400 hover:text-indigo-300 transition-colors disabled:opacity-50">
                                            {refining ? <span className="animate-pulse">Refining...</span> : <><Icons.Sparkles /> ✨ Refine with AI</>}
                                        </button>
                                    </div>
                                    <textarea 
                                        value={localData.logic || ''} 
                                        onChange={e=>handleChange('logic', e.target.value)}
                                        className="flex-1 w-full bg-slate-950 border border-slate-800 rounded-xl p-4 text-sm text-slate-300 outline-none focus:border-blue-500 transition-colors resize-none font-mono leading-relaxed"
                                        placeholder="Describe your setups, entries, exits, and emotional state... (Tip: Write rough notes then click 'Refine with AI')"
                                    ></textarea>
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-slate-500 uppercase">Tags / Mistakes</label>
                                    <input 
                                        type="text" 
                                        value={localData.tags || ''} 
                                        onChange={e=>handleChange('tags', e.target.value)}
                                        className="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-sm text-slate-300 outline-none focus:border-blue-500 transition-colors"
                                        placeholder="e.g. FOMO, Revenge Trading, Perfect Setup, Late Entry..."
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // NEW: Multi-tab AI Suite
        const AITradingSuite = ({ journalData, onClose, userProfile }) => {
            const [activeTab, setActiveTab] = useState('performance'); // 'performance' | 'coach'
            const [analysis, setAnalysis] = useState("");
            const [loadingAnalysis, setLoadingAnalysis] = useState(false);
            
            // Coach State
            const [chatHistory, setChatHistory] = useState([
                { role: 'assistant', text: "I am your Trading Psychologist. I can help you regulate emotions, handle losses, or prepare for the session. How are you feeling right now?" }
            ]);
            const [chatInput, setChatInput] = useState("");
            const [chatLoading, setChatLoading] = useState(false);
            const chatEndRef = useRef(null);

            useEffect(() => {
                if (chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: "smooth" });
            }, [chatHistory]);

            useEffect(() => {
                if(activeTab === 'performance' && !analysis) runAnalysis();
            }, [activeTab]);

            const runAnalysis = async () => {
                setLoadingAnalysis(true);
                try {
                    const filledDays = journalData.flatMap(m => m.days).filter(d => d.actual !== "" && Number(d.actual) > 0);
                    const wins = filledDays.filter(d => d.pnlSign === '+').length;
                    const losses = filledDays.filter(d => d.pnlSign === '-').length;
                    const totalPnL = filledDays.reduce((acc, d) => acc + (d.pnlSign === '+' ? Number(d.actual) : -Number(d.actual)), 0);
                    const recentNotes = filledDays.slice(-7).map(d => `Day ${d.day} (${d.pnlSign}${d.actual}): ${d.logic || "No notes"} [Rating: ${d.rating || 'N/A'}]`).join('\n');
                    
                    if(filledDays.length === 0) {
                        setAnalysis("Not enough data. Log trades to unlock analysis.");
                    } else {
                        const prompt = `Act as a senior quantitative mentor. Profile: ${userProfile?.style}. Stats: ${wins}W-${losses}L, PnL: ${totalPnL}. Recent Notes:\n${recentNotes}\nAnalyze my performance. Identify psychological patterns. Provide 3 specific bullet points to improve.`;
                        const res = await callGemini(prompt);
                        setAnalysis(res);
                    }
                } catch(e) { setAnalysis("Error generating analysis."); }
                setLoadingAnalysis(false);
            };

            const handleChatSend = async (e) => {
                e.preventDefault();
                if(!chatInput.trim()) return;
                const userMsg = { role: 'user', text: chatInput };
                setChatHistory(prev => [...prev, userMsg]);
                setChatInput("");
                setChatLoading(true);

                try {
                    const prompt = `You are a world-class Trading Psychologist (like Mark Douglas/Jared Tendler). The user is a trader. Help them regulate emotions, focus on process, and think in probabilities. Be concise, stoic, and practical. User says: "${userMsg.text}"`;
                    const res = await callGemini(prompt);
                    setChatHistory(prev => [...prev, { role: 'assistant', text: res }]);
                } catch(e) {
                    setChatHistory(prev => [...prev, { role: 'assistant', text: "Connection error. Try again." }]);
                }
                setChatLoading(false);
            };

            return (
                <div className="fixed inset-0 bg-slate-950/90 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-slate-900 border border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col h-[600px] animate-fade-in ring-1 ring-blue-500/20">
                        {/* Header Tabs */}
                        <div className="flex border-b border-slate-800 bg-slate-900/50 rounded-t-2xl">
                            <button onClick={()=>setActiveTab('performance')} className={`flex-1 p-4 font-bold text-sm flex items-center justify-center gap-2 transition-colors ${activeTab==='performance' ? 'text-blue-400 border-b-2 border-blue-500 bg-blue-500/5' : 'text-slate-500 hover:text-slate-300'}`}>
                                <Icons.AI /> Performance Review
                            </button>
                            <button onClick={()=>setActiveTab('coach')} className={`flex-1 p-4 font-bold text-sm flex items-center justify-center gap-2 transition-colors ${activeTab==='coach' ? 'text-indigo-400 border-b-2 border-indigo-500 bg-indigo-500/5' : 'text-slate-500 hover:text-slate-300'}`}>
                                <Icons.Chat /> Psychology Coach ✨
                            </button>
                            <button onClick={onClose} className="px-6 text-slate-400 hover:text-white border-l border-slate-800 hover:bg-rose-500/10 transition-colors">✕</button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-hidden relative bg-slate-900">
                            {activeTab === 'performance' ? (
                                <div className="p-8 h-full overflow-y-auto font-mono text-sm leading-relaxed text-slate-300">
                                    {loadingAnalysis ? <div className="flex flex-col items-center justify-center h-full gap-4"><div className="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div><span className="animate-pulse text-blue-400">CRUNCHING DATA...</span></div> : 
                                        <div className="prose prose-invert max-w-none prose-sm">{analysis.split('\n').map((line, i) => <p key={i} className="mb-2">{line.replace(/\*\*/g, '')}</p>)}</div> 
                                    }
                                </div>
                            ) : (
                                <div className="flex flex-col h-full">
                                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                        {chatHistory.map((msg, idx) => (
                                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`max-w-[80%] rounded-2xl p-4 text-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-300 rounded-bl-none border border-slate-700'}`}>
                                                    {msg.text}
                                                </div>
                                            </div>
                                        ))}
                                        {chatLoading && <div className="flex justify-start"><div className="bg-slate-800 p-4 rounded-2xl rounded-bl-none flex gap-1"><div className="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div><div className="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div><div className="w-2 h-2 bg-slate-500 rounded-full typing-dot"></div></div></div>}
                                        <div ref={chatEndRef}></div>
                                    </div>
                                    <form onSubmit={handleChatSend} className="p-4 border-t border-slate-800 bg-slate-900/50 flex gap-2">
                                        <input 
                                            value={chatInput} 
                                            onChange={e=>setChatInput(e.target.value)} 
                                            placeholder="Vent about a loss, ask for advice..."
                                            className="flex-1 bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm text-white focus:border-indigo-500 outline-none transition-colors"
                                        />
                                        <button type="submit" disabled={chatLoading} className="bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded-xl transition-colors disabled:opacity-50">
                                            <Icons.Sparkles />
                                        </button>
                                    </form>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. MAIN APP LOGIC ---

        function App({ user, onLogout }) {
            const [view, setView] = useState('journal');
            const [journalData, setJournalData] = useState(null);
            const [profileData, setProfileData] = useState(null);
            const [showAI, setShowAI] = useState(false);
            const [activeDay, setActiveDay] = useState(null); // { mIdx, dIdx, data }
            const [syncStatus, setSyncStatus] = useState('idle');
            
            const generateJournal = (days=66) => {
                let months = []; let date = new Date(); let count = 0;
                while(count < days) {
                    const mIdx = Math.floor(count / 22);
                    if(!months[mIdx]) months[mIdx] = { id: mIdx, monthName: date.toLocaleString('default', {month:'long'}), days: [] };
                    const dateStr = date.toISOString().split('T')[0];
                    months[mIdx].days.push({ 
                        day: count + 1, date: dateStr, capital: 0, target: 0, 
                        pnlSign: "+", actual: "", logic: "", rating: 0, tags: "", screenshot: "", rules: []
                    });
                    date.setDate(date.getDate() + 1);
                    while(date.getDay() === 0 || date.getDay() === 6) date.setDate(date.getDate() + 1);
                    count++;
                }
                return { initialCapital: 50000, finalTarget: 1000000, months };
            };

            const resizeJournal = (currentJournal, newTotalDays) => {
                const totalExisting = currentJournal.months.reduce((acc, m) => acc + m.days.length, 0);
                if (newTotalDays <= totalExisting) return currentJournal; // Don't shrink to avoid data loss for now

                const needed = newTotalDays - totalExisting;
                let date = new Date(); 
                // Fast forward date
                let dCount = 0;
                while(dCount < totalExisting) {
                    date.setDate(date.getDate() + 1);
                    while(date.getDay() === 0 || date.getDay() === 6) date.setDate(date.getDate() + 1);
                    dCount++;
                }

                const updatedMonths = [...currentJournal.months];
                let added = 0;
                while(added < needed) {
                    const mIdx = Math.floor((totalExisting + added) / 22);
                    if(!updatedMonths[mIdx]) updatedMonths[mIdx] = { id: mIdx, monthName: date.toLocaleString('default', {month:'long'}), days: [] };
                    const dateStr = date.toISOString().split('T')[0];
                    updatedMonths[mIdx].days.push({ 
                        day: totalExisting + added + 1, date: dateStr, capital: 0, target: 0, 
                        pnlSign: "+", actual: "", logic: "", rating: 0, tags: "", screenshot: "", rules: []
                    });
                    date.setDate(date.getDate() + 1);
                    while(date.getDay() === 0 || date.getDay() === 6) date.setDate(date.getDate() + 1);
                    added++;
                }
                return { ...currentJournal, months: updatedMonths };
            };

            useEffect(() => {
                const fetchData = async () => {
                    const journalRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('data').doc('journal');
                    const profileRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('data').doc('profile');
                    try {
                        const [jSnap, pSnap] = await Promise.all([journalRef.get(), profileRef.get()]);
                        let pData = pSnap.exists ? pSnap.data() : { name: '', style: 'Scalper', experience: 'Intermediate', duration: 66 };
                        let jData = null;

                        if (jSnap.exists) {
                            jData = jSnap.data();
                            // Auto resize if profile duration is larger than current journal
                            if (pData.duration) {
                                jData = resizeJournal(jData, pData.duration);
                            }
                        } else {
                            jData = generateJournal(pData.duration || 66);
                            journalRef.set(jData);
                        }
                        
                        setJournalData(jData);
                        setProfileData(pData);
                    } catch (error) { console.error(error); }
                };
                fetchData();
            }, [user.uid]);

            useEffect(() => {
                if(journalData) {
                    setSyncStatus('syncing');
                    const t = setTimeout(async () => {
                        try {
                            await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('data').doc('journal').set(journalData);
                            setSyncStatus('saved');
                            setTimeout(() => setSyncStatus('idle'), 2000);
                        } catch(e) { console.error(e); setSyncStatus('error'); }
                    }, 1500);
                    return () => clearTimeout(t);
                }
            }, [journalData, user.uid]);

            const handleProfileSave = async (data) => {
                setProfileData(data);
                // Resize journal if duration increased
                if (data.duration && journalData) {
                    const resized = resizeJournal(journalData, data.duration);
                    setJournalData(resized);
                }
                await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('data').doc('profile').set(data);
            };

            const updateDay = (mIdx, dIdx, fieldOrObj, val) => {
                const newData = {...journalData};
                if (typeof fieldOrObj === 'object') {
                    // Update entire object (from modal)
                    newData.months[mIdx].days[dIdx] = { ...newData.months[mIdx].days[dIdx], ...fieldOrObj };
                } else {
                    // Update single field
                    newData.months[mIdx].days[dIdx][fieldOrObj] = val;
                }
                setJournalData(newData);
            };

            const openDetailedModal = (mIdx, dIdx, day) => {
                setActiveDay({ mIdx, dIdx, data: day });
            };

            if(!journalData) return <div className="h-screen flex flex-col items-center justify-center bg-slate-950 text-blue-500 font-mono gap-4 animate-pulse">INITIALIZING TERMINAL...</div>;

            return (
                <div className="flex h-screen overflow-hidden bg-slate-950">
                    <div className="w-20 bg-slate-900 border-r border-slate-800 flex flex-col items-center py-8 gap-8 z-20">
                        <div className="text-blue-500 font-black text-2xl mb-2 tracking-tighter">DT</div>
                        <button onClick={() => setView('journal')} className={`p-4 rounded-2xl transition-all duration-300 relative group ${view==='journal' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}>
                            <Icons.Journal />
                        </button>
                        <button onClick={() => setView('profile')} className={`p-4 rounded-2xl transition-all duration-300 relative group ${view==='profile' ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800'}`}>
                            <Icons.User />
                        </button>
                        <div className="mt-auto">
                             <button onClick={onLogout} className="p-4 text-slate-500 hover:text-rose-500 hover:bg-rose-500/10 rounded-2xl transition-colors"><Icons.Settings /></button>
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden relative">
                        <div className="absolute top-0 left-0 w-full h-96 bg-blue-900/5 blur-[120px] pointer-events-none"></div>

                        <div className="flex-1 overflow-y-auto p-6 md:p-10 scroll-smooth z-10 custom-scrollbar">
                            <header className="flex justify-between items-center mb-8">
                                <div>
                                    <h1 className="text-3xl font-bold text-white tracking-tight">{view === 'journal' ? 'Trading Terminal' : 'Trader Profile'}</h1>
                                    <p className="text-slate-500 text-xs font-mono mt-2 flex items-center gap-2">
                                        STATUS: <span className="text-emerald-500">ONLINE</span>
                                        <span className="text-slate-700">|</span>
                                        {syncStatus === 'syncing' ? <span className="text-blue-400 animate-pulse">SYNCING...</span> : syncStatus === 'saved' ? <span className="text-slate-400">SAVED</span> : <span className="text-slate-600">READY</span>}
                                    </p>
                                </div>
                                {view === 'journal' && (
                                    <div className="flex gap-4">
                                        <button onClick={() => setShowAI(true)} className="flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-lg font-bold text-sm shadow-lg shadow-blue-500/20 transition-all border border-white/10 group">
                                            <Icons.Sparkles /> <span className="group-hover:translate-x-0.5 transition-transform">AI Suite</span>
                                        </button>
                                    </div>
                                )}
                            </header>

                            {view === 'profile' ? (
                                <ProfileSection user={user} profileData={profileData} onSave={handleProfileSave} />
                            ) : (
                                <div className="max-w-7xl animate-fade-in">
                                    <MonthlyReport months={journalData.months} />
                                    <div className="space-y-4">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-slate-400 font-bold uppercase text-xs tracking-wider">Active Month: {journalData.months[0].monthName}</h3>
                                        </div>

                                        {journalData.months[0].days.slice(0, 10).map((day, i) => (
                                            <div key={i} className="glass-panel rounded-lg p-[1px] hover:bg-slate-800/50 transition-colors group">
                                                <div className="bg-slate-900/40 p-3 rounded flex flex-col md:flex-row gap-4 items-center">
                                                    <div className="w-full md:w-28 flex flex-row md:flex-col justify-between md:justify-center items-center md:items-start pl-2">
                                                        <span className="text-xs font-bold text-slate-500 block uppercase tracking-wider">Day {day.day}</span>
                                                        <span className="text-sm font-mono text-slate-300">{day.date.slice(5)}</span>
                                                    </div>

                                                    <div className="flex items-center gap-2 bg-slate-950/80 p-1.5 rounded-lg border border-slate-800 shadow-inner">
                                                        <button onClick={()=>updateDay(0, i, 'pnlSign', '+')} className={`w-8 h-8 rounded flex items-center justify-center text-sm font-bold transition-all ${day.pnlSign==='+'?'bg-emerald-500 text-white':'text-slate-600 hover:bg-slate-800'}`}>+</button>
                                                        <input type="number" placeholder="0" value={day.actual} onChange={e=>updateDay(0, i, 'actual', e.target.value)} className="bg-transparent w-24 text-center font-mono text-lg font-bold outline-none text-white placeholder-slate-700"/>
                                                        <button onClick={()=>updateDay(0, i, 'pnlSign', '-')} className={`w-8 h-8 rounded flex items-center justify-center text-sm font-bold transition-all ${day.pnlSign==='-'?'bg-rose-500 text-white':'text-slate-600 hover:bg-slate-800'}`}>-</button>
                                                    </div>

                                                    <div className="flex-1 w-full relative">
                                                        <input type="text" placeholder="Summary..." value={day.logic} onChange={e=>updateDay(0, i, 'logic', e.target.value)}
                                                            className="w-full bg-transparent text-sm text-slate-300 outline-none border-b border-slate-800 focus:border-blue-500 transition-colors py-2 px-2 placeholder-slate-600 font-medium truncate pr-8" />
                                                    </div>
                                                    
                                                    <button onClick={() => openDetailedModal(0, i, day)} className="p-2 bg-slate-800 hover:bg-blue-600 text-slate-400 hover:text-white rounded-lg transition-colors" title="Detailed Entry">
                                                        <Icons.Maximize />
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="hidden xl:block w-96 bg-slate-950 border-l border-slate-800 p-6 z-10">
                            <NewsFeed />
                            <div className="mt-6 glass-panel p-6 rounded-xl border-l-4 border-l-emerald-500">
                                <div className="text-slate-300 font-bold uppercase tracking-wider text-xs border-b border-slate-700 pb-2 mb-3">Snapshot</div>
                                <div className="space-y-3 text-sm">
                                    <div className="flex justify-between items-center"><span className="text-slate-500">Capital</span> <span className="font-mono text-slate-300">{formatCurrency(journalData?.initialCapital)}</span></div>
                                    <div className="flex justify-between items-center"><span className="text-slate-500">Goal</span> <span className="font-mono text-emerald-400 font-bold">{formatCurrency(journalData?.finalTarget)}</span></div>
                                    <div className="flex justify-between items-center"><span className="text-slate-500">Days</span> <span className="font-mono text-blue-400 font-bold">{profileData?.duration || 66}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showAI && <AITradingSuite journalData={journalData.months} userProfile={profileData} onClose={()=>setShowAI(false)} />}
                    
                    {/* Detailed Modal */}
                    {activeDay && (
                        <DetailedEntryModal 
                            dayData={activeDay} 
                            onClose={() => setActiveDay(null)} 
                            onUpdate={(mIdx, dIdx, data) => {
                                updateDay(mIdx, dIdx, data);
                                setActiveDay(null);
                            }} 
                        />
                    )}
                </div>
            );
        }

        const Root = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token);
                    else await auth.signInAnonymously();
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(u => { setUser(u); setLoading(false); });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-blue-500 font-mono animate-pulse">AUTHENTICATING...</div>;
            return user ? <App user={user} onLogout={()=>auth.signOut()} /> : <div className="min-h-screen flex items-center justify-center bg-slate-950 text-red-500">Auth Failed</div>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Root />);
    </script>
</body>
</html>
